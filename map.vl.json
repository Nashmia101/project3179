{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": "Average Daily Rainfall (mm) — Peninsular Malaysia",
  "width": 800,
  "height": 560,
  "projection": { "type": "mercator" },
  "padding": { "bottom": 60 },

  "params": [
    {
      "name": "MinimumRainfallThreshold",
      "value": 2,
      "bind": {
        "input": "range",
        "min": 2,
        "max": 7,
        "step": 0.1,
        "name": "Show states with rainfall ≥ (mm):"
      }
    }
  ],

  "layer": [
    {
      "mark": { "type": "rect", "fill": "#cfe8f7" },
      "encoding": { "x": { "value": 0 }, "x2": { "value": 800 }, "y": { "value": 0 }, "y2": { "value": 560 } }
    },

    {
      "data": { "graticule": { "extent": [[99, 0], [106, 8]], "step": [1, 1] } },
      "mark": { "type": "geoshape", "filled": false, "stroke": "#9aa4b2", "strokeWidth": 0.6, "strokeOpacity": 0.5, "clip": true }
    },

    {
      "data": {
        "url": "https://raw.githubusercontent.com/Nashmia101/project3179/main/ne_10m.json",
        "format": { "type": "topojson", "feature": "ne_10m_admin_1_states_provinces" }
      },
      "transform": [
        {
          "lookup": "properties.state",
          "from": {
            "data": { "url": "https://raw.githubusercontent.com/Nashmia101/project3179/main/rainfall_state_avg.csv" },
            "key": "State",
            "fields": ["Avg Rainfall (mm)"]
          }
        },
        { "filter": "datum['Avg Rainfall (mm)'] != null" },
        { "filter": "toNumber(datum['Avg Rainfall (mm)']) >= toNumber(MinimumRainfallThreshold)" }
      ],
      "mark": { "type": "geoshape", "stroke": "#334155", "strokeWidth": 0.9 },
      "encoding": {
        "color": {
          "field": "Avg Rainfall (mm)",
          "type": "quantitative",
          "title": "Average daily rainfall (mm)",
          "scale": { "scheme": "purples", "domain": [2, 7], "nice": false },
          "legend": { "offset": 20 }
        },
        "tooltip": [
          { "field": "properties.state", "title": "State" },
          { "field": "Avg Rainfall (mm)", "title": "Average daily rainfall (mm)", "format": ".2f" }
        ]
      }
    },

    {
      "data": {
        "values": [
          { "State": "Terengganu", "lon": 103.1, "lat": 5.1 },
          { "State": "Kelantan", "lon": 102.2, "lat": 6.1 },
          { "State": "Pahang", "lon": 102.3, "lat": 3.7 },
          { "State": "Johor", "lon": 103.5, "lat": 1.9 },
          { "State": "Perak", "lon": 101.0, "lat": 4.8 },
          { "State": "Selangor", "lon": 101.5, "lat": 3.1 },
          { "State": "Negeri Sembilan", "lon": 102.2, "lat": 2.7 },
          { "State": "Melaka", "lon": 102.3, "lat": 2.2 },
          { "State": "Kedah", "lon": 100.6, "lat": 6.1 },
          { "State": "Perlis", "lon": 100.2, "lat": 6.6 },
          { "State": "Pulau Pinang", "lon": 100.33, "lat": 5.35 }
        ]
      },
      "transform": [
        {
          "lookup": "State",
          "from": {
            "data": { "url": "https://raw.githubusercontent.com/Nashmia101/project3179/main/rainfall_state_avg.csv" },
            "key": "State",
            "fields": ["Avg Rainfall (mm)"]
          }
        },
        { "filter": "datum['Avg Rainfall (mm)'] != null" },
        { "filter": "toNumber(datum['Avg Rainfall (mm)']) >= toNumber(MinimumRainfallThreshold)" }
      ],
      "mark": { "type": "text", "fontSize": 12, "fontWeight": 900, "color": "#000000" },
      "encoding": {
        "longitude": { "field": "lon" },
        "latitude": { "field": "lat" },
        "text": { "field": "State" }
      }
    },

    {
      "data": {
        "url": "https://raw.githubusercontent.com/Nashmia101/project3179/main/ne_10m.json",
        "format": { "type": "topojson", "feature": "ne_10m_admin_1_states_provinces" }
      },
      "transform": [
        {
          "lookup": "properties.state",
          "from": {
            "data": { "url": "https://raw.githubusercontent.com/Nashmia101/project3179/main/rainfall_state_avg.csv" },
            "key": "State",
            "fields": ["Avg Rainfall (mm)"]
          }
        },
        { "filter": "datum['Avg Rainfall (mm)'] != null" },
        { "filter": "toNumber(datum['Avg Rainfall (mm)']) >= toNumber(MinimumRainfallThreshold)" },

        { "aggregate": [{ "op": "count", "as": "nVisible" }] },
        { "calculate": "11", "as": "totalStates" },
        {
          "calculate": "'Number of states with average daily rainfall \\u2265 ' + format(toNumber(MinimumRainfallThreshold), '.2f') + ' mm: ' + datum.nVisible + ' of ' + datum.totalStates + '.'",
          "as": "countLabel"
        }
      ],
      "mark": {
        "type": "text",
        "fontSize": 15,
        "fontWeight": 900,
        "align": "right",
        "fill": "#111"
      },
      "encoding": { "x": { "value": 780 }, "y": { "value": 24 }, "text": { "field": "countLabel" } }
    },

    {
      "data": {
        "url": "https://raw.githubusercontent.com/Nashmia101/project3179/main/ne_10m.json",
        "format": { "type": "topojson", "feature": "ne_10m_admin_1_states_provinces" }
      },
      "transform": [
        {
          "lookup": "properties.state",
          "from": {
            "data": { "url": "https://raw.githubusercontent.com/Nashmia101/project3179/main/rainfall_state_avg.csv" },
            "key": "State",
            "fields": ["Avg Rainfall (mm)"]
          }
        },
        { "filter": "datum['Avg Rainfall (mm)'] != null" },
        { "filter": "toNumber(datum['Avg Rainfall (mm)']) >= toNumber(MinimumRainfallThreshold)" },
        { "window": [{ "op": "rank", "as": "r" }], "sort": [{ "field": "Avg Rainfall (mm)", "order": "descending" }] },
        { "filter": "datum.r == 1" },
        {
          "calculate": "'Highest rainfall among shown states: ' + datum.properties.state + ' — ' + format(datum['Avg Rainfall (mm)'], '.2f') + ' mm.'",
          "as": "maxLabel"
        }
      ],
      "mark": { "type": "text", "fontSize": 13, "fontWeight": 900, "align": "right", "fill": "#111"},
      "encoding": { "x": { "value": 780 }, "y": { "value": 46 }, "text": { "field": "maxLabel" } }
    },

    {
      "data": {
        "url": "https://raw.githubusercontent.com/Nashmia101/project3179/main/ne_10m.json",
        "format": { "type": "topojson", "feature": "ne_10m_admin_1_states_provinces" }
      },
      "transform": [
        {
          "lookup": "properties.state",
          "from": {
            "data": { "url": "https://raw.githubusercontent.com/Nashmia101/project3179/main/rainfall_state_avg.csv" },
            "key": "State",
            "fields": ["Avg Rainfall (mm)"]
          }
        },
        { "filter": "datum['Avg Rainfall (mm)'] != null" },
        { "filter": "toNumber(datum['Avg Rainfall (mm)']) >= toNumber(MinimumRainfallThreshold)" },
        { "window": [{ "op": "rank", "as": "r" }], "sort": [{ "field": "Avg Rainfall (mm)", "order": "ascending" }] },
        { "filter": "datum.r == 1" },
        {
          "calculate": "'Lowest rainfall among shown states: ' + datum.properties.state + ' — ' + format(datum['Avg Rainfall (mm)'], '.2f') + ' mm.'",
          "as": "minLabel"
        }
      ],
      "mark": { "type": "text", "fontSize": 13, "fontWeight": 900, "align": "right", "fill": "#111" },
      "encoding": { "x": { "value": 780 }, "y": { "value": 66 }, "text": { "field": "minLabel" } }
    }
  ],

  "config": { "view": { "stroke": null }, "legend": { "orient": "right" } }
}