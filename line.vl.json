{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": "Rainfall Trend (2014–2020) — Selected State",
  "width": 720,
  "height": 420,
  "padding": {"bottom": 56},

  "params": [
    {
      "name": "StatePick",
      "value": "Pahang",
      "bind": {
        "input": "select",
        "name": "Choose state: ",
        "options": [
          "Johor","Kedah","Kelantan","Melaka","NSembilan",
          "Pahang","Penang","Perak","Perlis",
          "Selangor","Selangor-Wilayah","Terengganu"
        ]
      }
    }
  ],

  "data": { "url": "rainfall_state_year_avg.csv" },

  "transform": [
    {"filter": "datum.State == StatePick"},
    {"calculate": "toNumber(datum.Avg_Rainfall_mm)", "as": "rain_mm"},
    {"calculate": "toNumber(datum.Year)", "as": "year_num"}
  ],

  "layer": [
    {
      "mark": {"type": "line", "point": {"filled": true, "size": 64}, "strokeWidth": 2},
      "encoding": {
        "x": {
          "field": "year_num",
          "type": "quantitative",
          "title": "Year",
          "scale": {"domain": [2014, 2020]},
          "axis": {"tickMinStep": 1, "format": "d"}
        },
        "y": {
          "field": "rain_mm",
          "type": "quantitative",
          "title": "Average daily rainfall (mm)",
          "scale": {"domainMin": 0, "nice": true}
        },
        "color": {"value": "#5b21b6"},
        "tooltip": [
          {"field": "State", "type": "nominal"},
          {"field": "year_num", "type": "quantitative", "title": "Year", "format": "d"},
          {"field": "rain_mm", "type": "quantitative", "title": "Avg daily rainfall (mm)", "format": ".2f"}
        ]
      }
    },

   
    {
      "transform": [
        {"aggregate": [{"op": "mean", "field": "rain_mm", "as": "mean_rain"}]},
        {"calculate": "'Mean: ' + format(datum.mean_rain, '.2f') + ' mm'", "as": "mean_label"}
      ],
      "layer": [
        {
          "mark": {"type": "rule", "stroke": "#111827", "strokeDash": [6,4], "strokeWidth": 1},
          "encoding": {"y": {"field": "mean_rain"}}
        },
        {
          "mark": {
            "type": "text",
            "align": "left",
            "baseline": "bottom",
            "dx": 6,
            "dy": -4,
            "fontSize": 11,
            "fontWeight": "bold",
            "color": "#111111",
            "stroke": "#ffffff",
            "strokeWidth": 0.4,
            "strokeJoin": "round"
          },
          "encoding": { "y": {"field": "mean_rain"}, "x": {"value": 2014.1}, "text": {"field": "mean_label"} }
        }
      ]
    },

   
    {
      "transform": [
        {"window": [{"op": "rank", "as": "r"}], "sort": [{"field": "rain_mm", "order": "descending"}]},
        {"filter": "datum.r == 1"},
        {
          "calculate": "'Wettest year: ' + format(datum.year_num, 'd') + ' (' + format(datum.rain_mm, '.2f') + ' mm)'",
          "as": "max_label"
        }
      ],
      "mark": {
        "type": "text",
        "align": "left",
        "baseline": "middle",
        "dx": 6,
        "fontSize": 11,
        "fontWeight": "bold",
        "color": "#111111",
        "stroke": "#ffffff",
        "strokeWidth": 0.6,
        "strokeJoin": "round"
      },
      "encoding": {
        "x": {"field": "year_num"},
        "y": {"field": "rain_mm"},
        "text": {"field": "max_label"}
      }
    }
  ],

  "config": { "view": {"stroke": null}, "axis": {"grid": true} }
}
