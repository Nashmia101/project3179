{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": {"text": "Humidity Composition — Share of Stations by Band", "fontSize": 18},
  "width": 520,
  "height": 420,
  "background": "#ffffff",

  "data": {
    "url": "https://raw.githubusercontent.com/Nashmia101/project3179/main/Humid_malaysia_CLEAN_2014_2020_IMPUTED.csv",
    "format": {"type": "csv"}
  },

  "params": [
    {
      "name": "YearPick",
      "value": 2020,
      "bind": {"input": "select", "name": "Year: ", "options": [2014,2015,2016,2017,2018,2019,2020]}
    }
  ],

  "transform": [
    {"filter": "toNumber(datum.Year) == toNumber(YearPick)"},

    {
      "calculate":
        "toNumber(isValid(datum['Mean Relative Humidity']) ? datum['Mean Relative Humidity'] : (isValid(datum.Mean_Relative_Humidity) ? datum.Mean_Relative_Humidity : (isValid(datum.Humidity) ? datum.Humidity : null)))",
      "as": "rh"
    },
    {
      "calculate":
        "isValid(datum.Station) ? datum.Station : (isValid(datum['Station Name']) ? datum['Station Name'] : (isValid(datum.Station_ID) ? datum.Station_ID : datum.State))",
      "as": "station"
    },
    { "calculate": "rh >= 80 ? '≥80%' : (rh >= 75 ? '75–80%' : (rh >= 70 ? '70–75%' : '<70%'))", "as": "RH_Band" },

    { "aggregate": [{ "op": "distinct", "field": "station", "as": "n" }], "groupby": ["RH_Band"] },
    { "window": [{ "op": "sum", "field": "n", "as": "total" }] },
    { "calculate": "n / total", "as": "pct" }
  ],

  "layer": [
    {
      "mark": { "type": "arc", "innerRadius": 110, "stroke": "#ffffff", "strokeWidth": 2 },
      "encoding": {
        "theta": { "field": "n", "type": "quantitative" },
        "color": {
          "field": "RH_Band",
          "type": "nominal",
          "title": "Humidity band",
          "sort": ["<70%", "70–75%", "75–80%", "≥80%"],
          "scale": { "scheme": "purples" }
        },
        "tooltip": [
          { "field": "RH_Band", "title": "Band" },
          { "field": "n", "title": "Stations", "format": "," },
          { "field": "pct", "title": "Share", "format": ".1%" }
        ]
      }
    },

    {
      "mark": { "type": "text", "radius": 140, "fontSize": 11, "fontWeight": "bold", "fill": "#1f2937" },
      "encoding": {
        "theta": { "field": "n", "type": "quantitative" },
        "text": { "field": "pct", "type": "quantitative", "format": ".0%" }
      }
    },

    {
      "transform": [
        { "window": [{ "op": "rank", "as": "rk" }], "sort": [{ "field": "pct", "order": "descending" }] },
        { "filter": "datum.rk == 1" },
        {
          "calculate":
            "datum.RH_Band + ' band is ' + format(datum.pct, '.0%') + ' of all stations in ' + toString(YearPick)",
          "as": "center_note"
        }
      ],
      "mark": { "type": "text", "align": "center", "baseline": "middle", "fontSize": 16, "fontWeight": "bold", "fill": "#0f766e" },
      "encoding": {
        "x": { "aggregate": "mean", "field": "n", "type": "quantitative" },
        "y": { "aggregate": "mean", "field": "n", "type": "quantitative" },
        "text": { "field": "center_note" }
      }
    }
  ]
}
